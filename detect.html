<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <script>
      let audioCtx = null;
      let analyser = null;
      let source = null;
      let state = null;
      let threshold = 256;
      let ticksRequiredForDetection = 10;

      function setState(newState) {
        state = newState;
        document.getElementById("state").innerText = state;
      }

      function sliderChanged () {
	  let span = document.getElementById("frequencyDisplay");
	  let slider = document.getElementById("frequencySlider");
	  span.innerHTML = slider.value;
      }

      function setup() {
        // create web audio api context
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;

        if (navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({audio: true})
            .then(function(stream) {
              source = audioCtx.createMediaStreamSource(stream);
              source.connect(analyser);

              document.getElementById("setup").setAttribute('disabled', 'disabled');

              setState("calibrating");
              setTimeout(function() {
                setState("listening");
              }, 5000);
              listen();
            }).catch(function(err) {
              console.log('The following error occurred: ' + err);
            })
        } else {
          console.log('getUserMedia not supported on your browser!');
        }
      }

      function emit() {
	let slider = document.getElementById("frequencySlider");
        const oscillator = audioCtx.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(slider.value, audioCtx.currentTime); // value in hertz
        oscillator.connect(audioCtx.destination);
        oscillator.start();
        setTimeout(function() {
          oscillator.stop();
        }, 1000);
      }

      function listen() {
        var bufferLength = analyser.frequencyBinCount;
        var dataArray = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(dataArray);

        // Get a canvas defined with ID "oscilloscope"
        var canvas = document.getElementById("oscilloscope");
        var canvasCtx = canvas.getContext("2d");

        let count = 0;
        let sum = 0;
        let varSum = 0;
        let ticksAboveThreshold = 0;

        function draw() {
          requestAnimationFrame(draw);

          analyser.getByteFrequencyData(dataArray);

          canvasCtx.fillStyle = "rgb(200, 200, 200)";
          canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

          canvasCtx.lineWidth = 2;
          canvasCtx.strokeStyle = "rgb(0, 0, 0)";

          canvasCtx.beginPath();

          var sliceWidth = canvas.width * 1.0 / bufferLength;
          var x = 0;

            var power = document.getElementById("power");
	    let slider = document.getElementById("frequencySlider");

          let bucket = Math.floor((slider.value / 22050.0) * bufferLength);
	    console.log(bufferLength);
	    console.log(bucket);
          power.innerText = JSON.stringify([(dataArray[bucket - 1]).toString(), (dataArray[bucket]).toString(), (dataArray[bucket + 1]).toString()]);

            for (var i = 0; i < bufferLength; i++) {
            var v = dataArray[i] / 128.0;
	      if (Math.abs(bucket - i) > 20) {
		  var v = 0
	      }
            var y = v * canvas.height / 2;

            if (i === 0) {
              canvasCtx.moveTo(x, y);
            } else {
              canvasCtx.lineTo(x, y);
            }

            x += sliceWidth;
          }

          if (state === "calibrating") {
            count++;
            sum = sum + dataArray[bucket];
            varSum = varSum + Math.pow(dataArray[bucket] - (sum / count), 2);
            threshold = (sum / count) + 3 * Math.sqrt(varSum / count);
            console.log("Threshold: ", threshold);
          } else {
            if (dataArray[bucket] > threshold) {
              ticksAboveThreshold++;
              if (state !== "tone" && ticksAboveThreshold > ticksRequiredForDetection) {
                setState("tone");
                console.log("Tone!");
              }
            } else {
              setState("listening");
              ticksAboveThreshold = 0;
            }
          }

          var power = document.getElementById("power");
          power.innerText = JSON.stringify(dataArray[bucket].toString());

          canvasCtx.lineTo(canvas.width, canvas.height / 2);
          canvasCtx.stroke();
        }

        draw();
      }
    </script>
  </head>
  <body>
    <div><button id="setup" onclick="setup()">setup!</button></div>
    <div><input id="frequencySlider" type="range" min="20" max="20000" value="44" style="width: 80%" oninput="sliderChanged()" onchange="sliderChanged()"></div>
    <div><button onclick="setup()">setup!</button></div>
    <div><button onclick="emit()">emit!</button></div>

    <h2 id="state"></h2>
    <canvas id="oscilloscope"></canvas>
    <div id="power"></div>
  </body>
</html>
