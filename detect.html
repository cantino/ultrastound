<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <script>
      // Constants you can change:
      let hz = 18000;
      let buckets = [767, 768];
      let numStd = 4;
      let ticksRequiredForDetection = 25;
      let fireflyPeriod = 300;

      // Other state
      let audioCtx = null;
      let analyser = null;
      let source = null;
      let state = null;
      let threshold = 0;
      let fireflyTime = Math.random() * fireflyPeriod;

      function setState(newState) {
        state = newState;
        if (state === "flashing") {
          document.getElementById("body").setAttribute("style", "background-color: #fff");
        } else {
          document.getElementById("body").setAttribute("style", "background-color: #333");
        }
        document.getElementById("state").innerText = state;
      }

      function go() {
        setState("listening");
      }

      function setup() {
        // create web audio api context
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;

        if (navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({audio: true})
            .then(function(stream) {
              source = audioCtx.createMediaStreamSource(stream);
              source.connect(analyser);

              document.getElementById("setup").setAttribute('disabled', 'disabled');

              setState("calibrating");
              setTimeout(function() {
                setState("ready");
              }, 5000);
              listen();
            }).catch(function(err) {
              console.log('The following error occurred: ' + err);
            })
        } else {
          console.log('getUserMedia not supported on your browser!');
        }
      }

      function emit(callback) {
        const oscillator = audioCtx.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(hz, audioCtx.currentTime); // value in hertz
        oscillator.connect(audioCtx.destination);
        oscillator.start();
        setTimeout(function() {
          oscillator.stop();
          if (callback) callback();
        }, 1000);
      }

      function listen() {
        let bufferLength = analyser.frequencyBinCount;
        let dataArray = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(dataArray);

        // Get a canvas defined with ID "oscilloscope"
        let canvas = document.getElementById("oscilloscope");
        let canvasCtx = canvas.getContext("2d");

        let count = 0;
        let sum = 0;
        let varSum = 0;
        let ticksAboveThreshold = 0;

        function draw() {
          requestAnimationFrame(draw);

          analyser.getByteFrequencyData(dataArray);

          canvasCtx.fillStyle = "rgb(200, 200, 200)";
          canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

          canvasCtx.lineWidth = 2;
          canvasCtx.strokeStyle = "rgb(0, 0, 0)";

          canvasCtx.beginPath();

          let sliceWidth = canvas.width * 1.0 / bufferLength;
          let x = 0;

          for (let i = 0; i < bufferLength; i++) {
            let v = dataArray[i] / 128.0;
            let y = v * canvas.height / 2;

            if (i === 0) {
              canvasCtx.moveTo(x, y);
            } else {
              canvasCtx.lineTo(x, y);
            }

            x += sliceWidth;
          }

          let max = 0;
          let argmax = -1;
          for (let i = 0; i < bufferLength; i++) {
            if (dataArray[i] > max) {
              max = dataArray[i];
              argmax = i;
            }
          }
          console.log("argmax: ", argmax);

          canvasCtx.lineTo(canvas.width, canvas.height / 2);
          canvasCtx.stroke();

          if (state === "calibrating") {
            count++;
            buckets.forEach((bucket) => {
              sum = sum + dataArray[bucket];
            });
            buckets.forEach((bucket) => {
              varSum = varSum + Math.pow(dataArray[bucket] - (sum / count), 2);
            });
            threshold = (sum / count) + numStd * Math.sqrt(varSum / count);
            console.log("Threshold: ", threshold);
          } else {
            if (state === "listening" || state === "tone") {
              // Check for tones
              sum = 0;
              buckets.forEach((bucket) => {
                sum = sum + dataArray[bucket];
              });
              if (sum > threshold) {
                ticksAboveThreshold++;
                if (state !== "tone" && ticksAboveThreshold > ticksRequiredForDetection) {
                  setState("tone");
                  // fireflyTime = fireflyTime + toneIncrement;
                  fireflyTime = (fireflyPeriod - fireflyTime) / 2.0;
                  console.log("Tone!");
                }
              } else {
                setState("listening");
                ticksAboveThreshold = 0;
              }
            }

            // Possibly flash
            fireflyTime++;
            if (fireflyTime > fireflyPeriod) {
              fireflyTime = 0;
              console.log("Flashing");

              if (state === "listening" || state === "tone") {
                setState("flashing");
                emit(function () {
                  setTimeout(function () {
                    setState("listening")
                  }, 500);
                });
              }
            }
          }
        }

        draw();
      }
    </script>
  </head>
  <body id="body">
    <div><button id="setup" onclick="setup()">setup!</button></div>
    <div><button onclick="go()">go!</button></div>

    <h2 id="state"></h2>
    <canvas id="oscilloscope"></canvas>
  </body>
</html>
