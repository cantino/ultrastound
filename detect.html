<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <script>
      let audioCtx = null;
      let analyser = null;
      let source = null;
      let hz = 5000;
      let stop = false;

      function setup() {
        // create web audio api context
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;

        if (navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({audio: true})
            .then(function(stream) {
              source = audioCtx.createMediaStreamSource(stream);
              source.connect(analyser);
            }).catch(function(err) {
              console.log('The following error occurred: ' + err);
            })
        } else {
          console.log('getUserMedia not supported on your browser!');
        }
      }

      function emit() {
        const oscillator = audioCtx.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(hz, audioCtx.currentTime); // value in hertz
        oscillator.connect(audioCtx.destination);
        oscillator.start();
        setTimeout(function() {
          oscillator.stop();
          stop = true;
        }, 1000);
      }

      function listen() {
        var bufferLength = analyser.frequencyBinCount;
        var dataArray = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(dataArray);

        // Get a canvas defined with ID "oscilloscope"
        var canvas = document.getElementById("oscilloscope");
        var canvasCtx = canvas.getContext("2d");

        function draw() {
          requestAnimationFrame(draw);

          analyser.getByteFrequencyData(dataArray);

          canvasCtx.fillStyle = "rgb(200, 200, 200)";
          canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

          canvasCtx.lineWidth = 2;
          canvasCtx.strokeStyle = "rgb(0, 0, 0)";

          canvasCtx.beginPath();

          var sliceWidth = canvas.width * 1.0 / bufferLength;
          var x = 0;

          for (var i = 0; i < bufferLength; i++) {

            var v = dataArray[i] / 128.0;
            var y = v * canvas.height / 2;

            if (i === 0) {
              canvasCtx.moveTo(x, y);
            } else {
              canvasCtx.lineTo(x, y);
            }

            x += sliceWidth;
          }

          var power = document.getElementById("power");
          let bucket = Math.floor((hz / 22050.0) * bufferLength);
          power.innerText = JSON.stringify([(dataArray[bucket - 1]).toString(), (dataArray[bucket]).toString(), (dataArray[bucket + 1]).toString()]);
          if (!stop) {
            let max = 0;
            let argmax = -1;
            for (var i = 0; i < bufferLength; i++) {
              if (dataArray[i] > max) {
                max = dataArray[i];
                argmax = i;
              }
            }
            console.log([max, argmax]);
          }

          canvasCtx.lineTo(canvas.width, canvas.height / 2);
          canvasCtx.stroke();
        }

        draw();
      }
    </script>
  </head>
  <body>
    <div><button onclick="setup()">setup!</button></div>
    <div><button onclick="emit()">emit!</button></div>
    <div><button onclick="listen()">listen!</button></div>

    <canvas id="oscilloscope"></canvas>
    <div id="power"></div>
  </body>
</html>
